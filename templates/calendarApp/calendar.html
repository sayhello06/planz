{% extends "calendarApp/base.html" %}

{% block content %}
    <!-- Add Event Modal -->
<div id="calendar"></div>
    <div id="addEventModal" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title">Add Event</h4>
                </div>
                <div class="modal-body">
                    <form id="eventForm">
                        <div class="form-group">
                            <label for="eventTitle">Event Title</label>
                            <input type="text" class="form-control" id="eventTitle" placeholder="Event Title">
                        </div>
                        <div class="form-group">
                            <label for="startTime">Start Time</label>
                            <div class='input-group date' id='startTime'>
                                <input type='text' class="form-control" />
                                <span class="input-group-addon">
                                    <span class="glyphicon glyphicon-calendar"></span>
                                </span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="endTime">End Time</label>
                            <div class='input-group date' id='endTime'>
                                <input type='text' class="form-control" />
                                <span class="input-group-addon">
                                    <span class="glyphicon glyphicon-calendar"></span>
                                </span>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveEvent">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Event Modal -->
    <div id="editEventModal" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title">Edit Event</h4>
                </div>
                <div class="modal-body">
                    <form id="editEventForm">
                        <div class="form-group">
                            <label for="editEventTitle">Event Title</label>
                            <input type="text" class="form-control" id="editEventTitle" placeholder="Event Title">
                        </div>
                        <div class="form-group">
                            <label for="editStartTime">Start Time</label>
                            <div class='input-group date' id='editStartTime'>
                                <input type='text' class="form-control" />
                                <span class="input-group-addon">
                                    <span class="glyphicon glyphicon-calendar"></span>
                                </span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="editEndTime">End Time</label>
                            <div class='input-group date' id='editEndTime'>
                                <input type='text' class="form-control" />
                                <span class="input-group-addon">
                                    <span class="glyphicon glyphicon-calendar"></span>
                                </span>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="updateEvent">Update</button>
                    <button type="button" class="btn btn-danger" id="deleteEvent">Delete</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scrpits %}
    <script>
        $(document).ready(function () {
            // Initialize datetimepickers
            $('#startTime').datetimepicker({
                format: 'YYYY-MM-DD HH:mm'
            });
            $('#endTime').datetimepicker({
                format: 'YYYY-MM-DD HH:mm'
            });
            $('#editStartTime').datetimepicker({
                format: 'YYYY-MM-DD HH:mm'
            });
            $('#editEndTime').datetimepicker({
                format: 'YYYY-MM-DD HH:mm'
            });

            var calendar = $('#calendar').fullCalendar({
                header: {
                    left: 'month,agendaWeek,agendaDay',
                    center: 'title',
                    right: 'prev, next'
                    //month,agendaWeek,agendaDay,today,
                },
                events: '/calendar/all_events',
                selectable: true,
                selectHelper: true,
                editable: true,
                eventLimit: true,
                select: function (start, end) {
                    $('#addEventModal').modal('show');
                    $('#startTime').data("DateTimePicker").date(start);
                    $('#endTime').data("DateTimePicker").date(end);

                    $('#saveEvent').off('click').on('click', function () {
                        var title = $('#eventTitle').val();
                        var start = $('#startTime').data("DateTimePicker").date().format('YYYY-MM-DD HH:mm');
                        var end = $('#endTime').data("DateTimePicker").date().format('YYYY-MM-DD HH:mm');

                        if (title) {
                            $.ajax({
                                type: "GET",
                                url: '/calendar/add_event',
                                data: {
                                    'title': title,
                                    'start': start,
                                    'end': end
                                },
                                dataType: "json",
                                success: function () {
                                    calendar.fullCalendar('refetchEvents');
                                    $('#addEventModal').modal('hide');
                                },
                                error: function () {
                                    alert('There is a problem!!!');
                                }
                            });
                        }
                    });
                },
                eventResize: function (event) {
                    var start = moment(event.start).format('YYYY-MM-DD HH:mm');
                    var end = moment(event.end).format('YYYY-MM-DD HH:mm');
                    var title = event.title;
                    var id = event.id;
                    $.ajax({
                        type: "GET",
                        url: '/calendar/update',
                        data: {
                            'title': title,
                            'start': start,
                            'end': end,
                            'id': id
                        },
                        dataType: "json",
                        success: function () {
                            calendar.fullCalendar('refetchEvents');
                        },
                        error: function () {
                            alert('There is a problem!!!');
                        }
                    });
                },
                eventDrop: function (event) {
                    var start = moment(event.start).format('YYYY-MM-DD HH:mm');
                    var end = moment(event.end).format('YYYY-MM-DD HH:mm');
                    var title = event.title;
                    var id = event.id;
                    $.ajax({
                        type: "GET",
                        url: '/calendar/update_event',
                        data: {
                            'title': title,
                            'start': start,
                            'end': end,
                            'id': id
                        },
                        dataType: "json",
                        success: function () {
                            calendar.fullCalendar('refetchEvents');
                        },
                        error: function () {
                            alert('There is a problem!!!');
                        }
                    });
                },
                eventClick: function (event) {
                    $('#editEventModal').modal('show');
                    $('#editEventTitle').val(event.title);
                    $('#editStartTime').data("DateTimePicker").date(event.start);
                    $('#editEndTime').data("DateTimePicker").date(event.end);

                    $('#updateEvent').off('click').on('click', function () {
                        var title = $('#editEventTitle').val();
                        var start = $('#editStartTime').data("DateTimePicker").date().format('YYYY-MM-DD HH:mm');
                        var end = $('#editEndTime').data("DateTimePicker").date().format('YYYY-MM-DD HH:mm');

                        if (title) {
                            $.ajax({
                                type: "GET",
                                url: '/calendar/update_event',
                                data: {
                                    'title': title,
                                    'start': start,
                                    'end': end,
                                    'id': event.id
                                },
                                dataType: "json",
                                success: function () {
                                    calendar.fullCalendar('refetchEvents');
                                    $('#editEventModal').modal('hide');
                                },
                                error: function () {
                                    alert('There is a problem!!!');
                                }
                            });
                        }
                    });

                    $('#deleteEvent').off('click').on('click', function () {
                        $.ajax({
                            type: "GET",
                            url: '/calendar/remove_event',
                            data: {'id': event.id},
                            dataType: "json",
                            success: function () {
                                calendar.fullCalendar('refetchEvents');
                                $('#editEventModal').modal('hide');
                            },
                            error: function () {
                                alert('There is a problem!!!');
                            }
                        });
                        
                    });
                },
            });
        });
    </script>
{% endblock %}
